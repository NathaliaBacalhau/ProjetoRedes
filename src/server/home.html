<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>File Cloud</title>
		<link rel="shortcut icon" type="image/png"
			href="https://cdn.icon-icons.com/icons2/1603/PNG/512/symbol-computing-cloud-syncronize-folder_108651.png" />
		<style>
			@import url("https://fonts.googleapis.com/css2?family=Rubik+Bubbles&display=swap");

			body {
				font-family: Arial, sans-serif;
				background-color: #ffffff;
				margin: 0;
				padding: 0;
				display: flex;
				flex-direction: column;
				justify-content: center;
				align-items: center;
				text-align: center;
				height: 100vh;
			}

			h1 {
				color: #3a454b;
				font-family: "Rubik Bubbles", sans-serif;
			}

			img {
				width: 100px;
			}

			.nameContent {
				display: inline-flex;
				align-items: center;
				justify-content: center;
				gap: 10px;
				padding-bottom: 40px;
			}

			.dropzone {
				padding: 20px;
				margin: 10px 0;
				width: 60%;
				border: 4px solid;
				border-radius: 5px;
				border-color: rgb(0, 0, 0);
			}

			.fileLink {
				display: inline-block;
				margin: 5px;
			}

			#fileName {
				margin: 10px;
				display: inline-block;
				text-align: center;
			}

			#fileContent {
				margin: 10px;
				width: 50%;
				height: 25%;
				resize: none;
			}

			#fileExplorer {
				background-color: #4CAF50;
				/* Green */
				border: none;
				color: white;
				text-align: center;
				text-decoration: none;
				display: inline-block;
				font-size: 16px;
			}
		</style>
	</head>

	<body>
		<div class="nameContent">
			<div>
				<img src="https://cdn.icon-icons.com/icons2/1603/PNG/512/symbol-computing-cloud-syncronize-folder_108651.png"
					alt="File Cloud" />
			</div>
			<div>
				<h1>File Cloud</h1>
			</div>
		</div>

		<div>
			<button id="navigator" onclick="goBack()">&lt;</button>

			<input type="text" id="folder" disabled>
		</div>

		<button id="fileExplorer" onclick="fileExplorer()">Abra seu explorador...</button>

		<div id="files" class="dropzone" ondragover="allowDrop(event)" ondrop="dropHandler(event)">

		</div>

		<input type="text" id="fileName" disabled>

		<textarea name="textArea" id="fileContent">

		</textarea>

		<script>
			const stack = ["$root$"];

			function path() {
				return stack.join('\\');
			}

			function allowDrop(event) {
				event.preventDefault();
				const dropzone = document.getElementById('files');
				if (dropzone) {
					dropzone.classList.add('active');
				}
			}

			function dropHandler(event) {
				event.preventDefault();
				const dropzone = document.getElementById('files');
				if (dropzone) {
					dropzone.classList.remove('active');
				}
				const files = event.dataTransfer.files;
				for (const file of files) {
					const reader = new FileReader();
					reader.onload = function (e) {
						const content = e.target.result;
						createFile(file.name, content);
					};
					reader.readAsText(file);
				}
			}

			function clearLinks() {
				document.querySelectorAll('.fileLink').forEach(link => {
					document.getElementById('files').removeChild(link);
				});
				document.getElementById('fileName').value = "";
				document.getElementById('fileContent').value = "";
			}

			function goBack() {
				stack.pop();
				getAll();
			}

			function getAll() {
				document.getElementById('folder').value = path();
				if (stack.length == 1) {
					document.getElementById('navigator').disabled = true;
				} else document.getElementById('navigator').disabled = false;
				clearLinks();
				fetch(`/getAll/${path()}`, {
					method: 'GET'
				})
					.then(response => response.text())
					.then(files => {
						files = files.substring(1, files.length - 1);
						if (files.length) {
							const fileList = files.split(',').map(file => file.trim());
							for (const file of fileList) {
								const link = document.createElement('a');
								link.className = 'fileLink';
								link.href = `/get/${path()}/${file}`;
								link.innerText = file;
								document.getElementById('files').appendChild(link);
							}
						}
					})
					.then(() => {
						document.querySelectorAll('.fileLink').forEach(link => {
							link.onclick = function (event) {
								event.preventDefault();

								const regex = /\.[a-zA-Z0-9]{1,5}$/;
								function hasFileExtension(fileName) {
									return regex.test(fileName);
								}

								if (hasFileExtension(link.innerText)) {
									fetch(link.href)
										.then(response => response.text())
										.then(content => {
											document.getElementById('fileName').value = link.innerText;
											document.getElementById('fileContent').value = content;
										});
								} else {
									stack.push(link.innerText);
									getAll();
								}
							}
							let pressTimer;
							link.addEventListener('mousedown', function () {
								pressTimer = window.setTimeout(function () {
									const confirmacao = window.confirm("Deseja deletar?");
									if (confirmacao) {
										deleteFile(link.innerText);
									}
								}, 500);
							});
							link.addEventListener('mouseup', function () {
								clearTimeout(pressTimer);
							});
						});
					});
			}

			// Função para criar um novo arquivo
			function createFile(name, data) {
				fetch(`/create/${path()}`, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({ name: name, data: data }),
				});
			}

			function fileExplorer() {
				let input = document.createElement('input');
				input.type = 'file';
				input.multiple = true;
				input.onchange = () => {
					let files = Array.from(input.files);
					for (const file of files) {
						const reader = new FileReader();
						reader.onload = function (e) {
							const content = e.target.result;
							createFile(file.name.replaceAll(" ", ""), content);
						};
						reader.readAsText(file);
					}
				};
				input.click();
			}

			// Função para ver arquivos existentes
			function getFile() {
				const nome = document.getElementById('nomeBuscar').value;
				if (!nome) {
					alert('Preencha os campo de busca');
					return;
				}
				stack.push(nome);
				fetch(`/get/${path()}`, {
					method: 'GET'
				}).then(response => {
					return response.text();
				}).then(data => {
					document.getElementById('textoGet').value = data;
					stack.pop();
				});
			}

			// Função para excluir um arquivo existente
			function deleteFile(nome) {
				stack.push(nome);
				fetch(`/delete/${path()}`, {
					method: 'DELETE'
				}).then(response => response.statusText).then(message => {
					stack.pop();
				}).then(() => {
					getAll();
				});
			}

			getAll();
		</script>
	</body>

</html>